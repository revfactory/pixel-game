<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>픽셀 마을 게임</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: #2d5016;
            font-family: 'Courier New', monospace;
            transition: background 1s;
        }

        body.stage2 {
            background: #1a1a2e;
        }

        #gameCanvas {
            border: 4px solid #1a2e0a;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            background: #7fba3d;
        }

        #dialogue {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            border: 3px solid white;
            max-width: 500px;
            display: none;
            font-size: 14px;
        }

        #dialogue.show {
            display: block;
        }

        #instructions {
            margin-top: 20px;
            color: white;
            text-align: center;
            font-size: 14px;
        }

        #inventory {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            border: 2px solid white;
        }

        #stageInfo {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            border: 2px solid white;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas" width="640" height="480"></canvas>
    <div id="dialogue"></div>
    <div id="stageInfo">Stage <span id="stageNum">1</span></div>
    <div id="inventory"><span id="itemIcon">🐛</span> <span id="itemName">벌레</span>: <span id="bugCount">0</span>/<span id="bugGoal">10</span></div>
    <div id="instructions">
        ⬆️⬇️⬅️➡️ 이동 | 스페이스바: 대화/잡기 | ESC: 대화 닫기
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const dialogue = document.getElementById('dialogue');
        const bugCountEl = document.getElementById('bugCount');
        const bugGoalEl = document.getElementById('bugGoal');
        const stageNumEl = document.getElementById('stageNum');
        const itemIconEl = document.getElementById('itemIcon');
        const itemNameEl = document.getElementById('itemName');

        const TILE_SIZE = 32;
        const MAP_WIDTH = 20;
        const MAP_HEIGHT = 15;

        // Game state
        const game = {
            stage: 1,
            player: {
                x: 10,
                y: 7,
                direction: 'down'
            },
            bugs: [],
            bugsCaught: 0,
            bugsNeeded: 10,
            dialogueOpen: false,
            currentDialogue: null,
            transitioning: false
        };

        // Map generator
        let map = [];
        let villagers = [];

        function generateStage1Map() {
            return Array(MAP_HEIGHT).fill().map((_, y) =>
                Array(MAP_WIDTH).fill().map((_, x) => {
                    // Create borders with trees
                    if (x === 0 || x === MAP_WIDTH - 1 || y === 0 || y === MAP_HEIGHT - 1) return 1;
                    // Add some water patches
                    if ((x >= 15 && x <= 17 && y >= 3 && y <= 5) ||
                        (x >= 3 && x <= 5 && y >= 10 && y <= 12)) return 2;
                    // Random trees
                    if (Math.random() < 0.05) return 1;
                    return 0;
                })
            );
        }

        function generateStage2Map() {
            return Array(MAP_HEIGHT).fill().map((_, y) =>
                Array(MAP_WIDTH).fill().map((_, x) => {
                    // Create borders with graves (type 3)
                    if (x === 0 || x === MAP_WIDTH - 1 || y === 0 || y === MAP_HEIGHT - 1) return 3;
                    // Add some gravestones randomly
                    if (Math.random() < 0.08) return 3;
                    // Dark fog patches (type 4)
                    if ((x >= 5 && x <= 7 && y >= 5 && y <= 7) ||
                        (x >= 14 && x <= 16 && y >= 10 && y <= 12)) return 4;
                    return 0; // Dark ground
                })
            );
        }

        map = generateStage1Map();

        // Villagers setup
        function setupStage1Villagers() {
            return [
                {
                    x: 5, y: 5,
                    name: '할아버지',
                    dialogues: [
                        '안녕하세! 오늘은 날씨가 좋구만!',
                        '벌레를 잡고 다니는구나? 조심히 다니렴.',
                        '예전엔 나도 벌레를 많이 잡았지...'
                    ]
                },
                {
                    x: 15, y: 8,
                    name: '소녀',
                    dialogues: [
                        '안녕하세요! 저는 이 마을에 사는 소녀예요.',
                        '나비를 보셨나요? 정말 예쁘답니다!',
                        '마을 주변에 멋진 벌레들이 많아요.'
                    ]
                },
                {
                    x: 8, y: 12,
                    name: '농부',
                    dialogues: [
                        '이봐요, 벌레 잡는 사람! 환영합니다.',
                        '농사일이 힘들지만 보람찹니다.',
                        '물가 근처에 특별한 벌레들이 있어요.'
                    ]
                }
            ];
        }

        function setupStage2Villagers() {
            return [
                {
                    x: 6, y: 6,
                    name: '유령 할머니',
                    isGhost: true,
                    dialogues: [
                        '우우우... 여긴 어떻게 온 거냐...',
                        '이곳은 잃어버린 영혼들의 마을...',
                        '유령들을 구해주면... 평화가 찾아올 것이다...'
                    ]
                },
                {
                    x: 14, y: 11,
                    name: '유령 소년',
                    isGhost: true,
                    dialogues: [
                        '후후... 놀아줄 사람이 필요해...',
                        '여기서 영원히... 함께 놀자...',
                        '외롭지 않게 해줘...'
                    ]
                }
            ];
        }

        villagers = setupStage1Villagers();

        // Initialize bugs
        function spawnBug() {
            let x, y;
            do {
                x = Math.floor(Math.random() * (MAP_WIDTH - 2)) + 1;
                y = Math.floor(Math.random() * (MAP_HEIGHT - 2)) + 1;
            } while (map[y][x] !== 0 || (x === game.player.x && y === game.player.y));

            if (game.stage === 1) {
                return {
                    x, y,
                    type: Math.random() < 0.3 ? 'butterfly' : 'bug',
                    moveCooldown: 0
                };
            } else {
                return {
                    x, y,
                    type: Math.random() < 0.4 ? 'ghost2' : 'ghost1',
                    moveCooldown: 0,
                    opacity: Math.random() * 0.5 + 0.5
                };
            }
        }

        function initBugs() {
            game.bugs = [];
            const count = game.stage === 1 ? 8 : 10;
            for (let i = 0; i < count; i++) {
                game.bugs.push(spawnBug());
            }
        }

        initBugs();

        // Draw functions
        function drawTile(x, y, type) {
            const px = x * TILE_SIZE;
            const py = y * TILE_SIZE;

            if (game.stage === 1) {
                if (type === 0) { // Grass
                    ctx.fillStyle = '#7fba3d';
                    ctx.fillRect(px, py, TILE_SIZE, TILE_SIZE);
                    ctx.fillStyle = '#6ba82d';
                    ctx.fillRect(px + 8, py + 8, 4, 4);
                    ctx.fillRect(px + 20, py + 16, 4, 4);
                } else if (type === 1) { // Tree
                    ctx.fillStyle = '#4a7023';
                    ctx.fillRect(px, py, TILE_SIZE, TILE_SIZE);
                    ctx.fillStyle = '#3a5019';
                    ctx.fillRect(px + 12, py + 4, 8, 24);
                    ctx.fillStyle = '#2d6b16';
                    ctx.fillRect(px + 4, py + 4, 24, 16);
                } else if (type === 2) { // Water
                    ctx.fillStyle = '#4e9cd9';
                    ctx.fillRect(px, py, TILE_SIZE, TILE_SIZE);
                    ctx.fillStyle = '#6bb3ff';
                    ctx.fillRect(px + 4, py + 4, 8, 8);
                    ctx.fillRect(px + 20, py + 16, 8, 8);
                }
            } else { // Stage 2
                if (type === 0) { // Dark ground
                    ctx.fillStyle = '#2a2a3e';
                    ctx.fillRect(px, py, TILE_SIZE, TILE_SIZE);
                    ctx.fillStyle = '#1f1f2e';
                    ctx.fillRect(px + 8, py + 8, 4, 4);
                    ctx.fillRect(px + 20, py + 16, 4, 4);
                } else if (type === 3) { // Gravestone
                    ctx.fillStyle = '#1a1a2e';
                    ctx.fillRect(px, py, TILE_SIZE, TILE_SIZE);
                    ctx.fillStyle = '#555';
                    ctx.fillRect(px + 10, py + 12, 12, 16);
                    ctx.fillStyle = '#333';
                    ctx.fillRect(px + 12, py + 8, 8, 8);
                } else if (type === 4) { // Fog
                    ctx.fillStyle = '#2a2a3e';
                    ctx.fillRect(px, py, TILE_SIZE, TILE_SIZE);
                    ctx.fillStyle = 'rgba(100, 100, 150, 0.3)';
                    ctx.fillRect(px, py, TILE_SIZE, TILE_SIZE);
                }
            }
        }

        function drawPlayer(x, y, direction) {
            const px = x * TILE_SIZE;
            const py = y * TILE_SIZE;

            // Body
            ctx.fillStyle = '#ff6b6b';
            ctx.fillRect(px + 8, py + 16, 16, 12);

            // Head
            ctx.fillStyle = '#ffcc99';
            ctx.fillRect(px + 10, py + 8, 12, 10);

            // Eyes
            ctx.fillStyle = '#000';
            ctx.fillRect(px + 12, py + 11, 2, 2);
            ctx.fillRect(px + 18, py + 11, 2, 2);

            // Legs
            ctx.fillStyle = '#4a4a4a';
            ctx.fillRect(px + 10, py + 28, 4, 4);
            ctx.fillRect(px + 18, py + 28, 4, 4);
        }

        function drawVillager(villager) {
            const px = villager.x * TILE_SIZE;
            const py = villager.y * TILE_SIZE;

            if (villager.isGhost) {
                // Ghost villager
                ctx.globalAlpha = 0.7;
                ctx.fillStyle = '#ccc';
                ctx.fillRect(px + 8, py + 16, 16, 12);
                ctx.fillStyle = '#fff';
                ctx.fillRect(px + 10, py + 8, 12, 10);
                ctx.fillStyle = '#000';
                ctx.fillRect(px + 12, py + 11, 2, 2);
                ctx.fillRect(px + 18, py + 11, 2, 2);
                ctx.globalAlpha = 1;
            } else {
                // Normal villager
                ctx.fillStyle = '#6b4eff';
                ctx.fillRect(px + 8, py + 16, 16, 12);
                ctx.fillStyle = '#ffcc99';
                ctx.fillRect(px + 10, py + 8, 12, 10);
                ctx.fillStyle = '#000';
                ctx.fillRect(px + 12, py + 11, 2, 2);
                ctx.fillRect(px + 18, py + 11, 2, 2);
                ctx.fillStyle = '#4a4a4a';
                ctx.fillRect(px + 10, py + 28, 4, 4);
                ctx.fillRect(px + 18, py + 28, 4, 4);
            }
        }

        function drawBug(bug) {
            const px = bug.x * TILE_SIZE;
            const py = bug.y * TILE_SIZE;

            if (bug.type === 'butterfly') {
                // Butterfly
                ctx.fillStyle = '#ff1493';
                ctx.fillRect(px + 10, py + 14, 6, 6);
                ctx.fillRect(px + 16, py + 14, 6, 6);
                ctx.fillStyle = '#000';
                ctx.fillRect(px + 15, py + 12, 2, 10);
            } else if (bug.type === 'bug') {
                // Regular bug
                ctx.fillStyle = '#654321';
                ctx.fillRect(px + 14, py + 16, 4, 8);
                ctx.fillStyle = '#000';
                ctx.fillRect(px + 12, py + 18, 2, 2);
                ctx.fillRect(px + 18, py + 18, 2, 2);
            } else if (bug.type === 'ghost1') {
                // Ghost type 1
                ctx.globalAlpha = bug.opacity;
                ctx.fillStyle = '#e0e0ff';
                ctx.fillRect(px + 10, py + 12, 12, 14);
                ctx.fillStyle = '#000';
                ctx.fillRect(px + 12, py + 16, 2, 2);
                ctx.fillRect(px + 18, py + 16, 2, 2);
                ctx.fillStyle = '#e0e0ff';
                ctx.fillRect(px + 10, py + 26, 3, 4);
                ctx.fillRect(px + 15, py + 26, 3, 4);
                ctx.fillRect(px + 20, py + 26, 2, 4);
                ctx.globalAlpha = 1;
            } else if (bug.type === 'ghost2') {
                // Ghost type 2
                ctx.globalAlpha = bug.opacity;
                ctx.fillStyle = '#ffd0ff';
                ctx.fillRect(px + 10, py + 12, 12, 14);
                ctx.fillStyle = '#000';
                ctx.fillRect(px + 12, py + 16, 2, 2);
                ctx.fillRect(px + 18, py + 16, 2, 2);
                ctx.fillStyle = '#ffd0ff';
                ctx.fillRect(px + 10, py + 26, 3, 4);
                ctx.fillRect(px + 15, py + 26, 3, 4);
                ctx.fillRect(px + 20, py + 26, 2, 4);
                ctx.globalAlpha = 1;
            }
        }

        // Stage transition
        function transitionToStage2() {
            game.transitioning = true;
            dialogue.textContent = '모든 벌레를 잡았다! 갑자기 어두운 기운이...';
            dialogue.classList.add('show');

            setTimeout(() => {
                game.stage = 2;
                game.bugsCaught = 0;
                game.bugsNeeded = 15;
                map = generateStage2Map();
                villagers = setupStage2Villagers();
                game.player.x = 10;
                game.player.y = 7;
                initBugs();

                stageNumEl.textContent = '2';
                itemIconEl.textContent = '👻';
                itemNameEl.textContent = '유령';
                bugCountEl.textContent = '0';
                bugGoalEl.textContent = '15';
                document.body.classList.add('stage2');

                dialogue.textContent = 'Stage 2: 유령 마을! 모든 유령을 구해내라!';
                setTimeout(() => {
                    dialogue.classList.remove('show');
                    game.transitioning = false;
                }, 3000);
            }, 2000);
        }

        // Game logic
        function canMoveTo(x, y) {
            if (x < 0 || x >= MAP_WIDTH || y < 0 || y >= MAP_HEIGHT) return false;
            if (map[y][x] !== 0 && map[y][x] !== 4) return false;
            if (villagers.some(v => v.x === x && v.y === y)) return false;
            return true;
        }

        function movePlayer(dx, dy) {
            if (game.dialogueOpen || game.transitioning) return;

            const newX = game.player.x + dx;
            const newY = game.player.y + dy;

            if (dx > 0) game.player.direction = 'right';
            else if (dx < 0) game.player.direction = 'left';
            else if (dy > 0) game.player.direction = 'down';
            else if (dy < 0) game.player.direction = 'up';

            if (canMoveTo(newX, newY)) {
                game.player.x = newX;
                game.player.y = newY;
            }
        }

        function interact() {
            if (game.transitioning) return;

            if (game.dialogueOpen) {
                dialogue.classList.remove('show');
                game.dialogueOpen = false;
                game.currentDialogue = null;
                return;
            }

            // Check for villagers
            for (let villager of villagers) {
                const dist = Math.abs(villager.x - game.player.x) + Math.abs(villager.y - game.player.y);
                if (dist === 1) {
                    const randomDialogue = villager.dialogues[Math.floor(Math.random() * villager.dialogues.length)];
                    dialogue.textContent = `${villager.name}: ${randomDialogue}`;
                    dialogue.classList.add('show');
                    game.dialogueOpen = true;
                    return;
                }
            }

            // Check for bugs/ghosts
            for (let i = game.bugs.length - 1; i >= 0; i--) {
                const bug = game.bugs[i];
                const dist = Math.abs(bug.x - game.player.x) + Math.abs(bug.y - game.player.y);
                if (dist <= 1) {
                    game.bugs.splice(i, 1);
                    game.bugsCaught++;
                    bugCountEl.textContent = game.bugsCaught;

                    let message = '';
                    if (game.stage === 1) {
                        message = bug.type === 'butterfly' ? '나비를 잡았다! 🦋' : '벌레를 잡았다! 🐛';
                    } else {
                        message = bug.type === 'ghost2' ? '분홍 유령을 구했다! 👻' : '하얀 유령을 구했다! 👻';
                    }

                    dialogue.textContent = message;
                    dialogue.classList.add('show');
                    setTimeout(() => dialogue.classList.remove('show'), 1500);

                    // Check stage completion
                    if (game.bugsCaught >= game.bugsNeeded) {
                        if (game.stage === 1) {
                            transitionToStage2();
                        } else {
                            setTimeout(() => {
                                dialogue.textContent = '모든 유령을 구했다! 게임 클리어! 🎉';
                                dialogue.classList.add('show');
                            }, 2000);
                        }
                    } else if (game.bugs.length < 5) {
                        // Spawn new bug/ghost if running low
                        setTimeout(() => {
                            game.bugs.push(spawnBug());
                        }, 2000);
                    }
                    return;
                }
            }
        }

        function updateBugs() {
            game.bugs.forEach(bug => {
                bug.moveCooldown--;
                if (bug.moveCooldown <= 0) {
                    bug.moveCooldown = game.stage === 1 ? 60 : 40;

                    const moves = [{dx: 0, dy: 0}, {dx: 1, dy: 0}, {dx: -1, dy: 0}, {dx: 0, dy: 1}, {dx: 0, dy: -1}];
                    const move = moves[Math.floor(Math.random() * moves.length)];
                    const newX = bug.x + move.dx;
                    const newY = bug.y + move.dy;

                    if (canMoveTo(newX, newY) && !(newX === game.player.x && newY === game.player.y)) {
                        bug.x = newX;
                        bug.y = newY;
                    }
                }

                // Animate ghost opacity
                if (bug.type === 'ghost1' || bug.type === 'ghost2') {
                    bug.opacity = Math.sin(Date.now() / 500 + bug.x + bug.y) * 0.2 + 0.7;
                }
            });
        }

        // Render
        function render() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw map
            for (let y = 0; y < MAP_HEIGHT; y++) {
                for (let x = 0; x < MAP_WIDTH; x++) {
                    drawTile(x, y, map[y][x]);
                }
            }

            // Draw bugs
            game.bugs.forEach(drawBug);

            // Draw villagers
            villagers.forEach(v => drawVillager(v));

            // Draw player
            drawPlayer(game.player.x, game.player.y, game.player.direction);
        }

        // Game loop
        function gameLoop() {
            updateBugs();
            render();
            requestAnimationFrame(gameLoop);
        }

        // Input handling
        document.addEventListener('keydown', (e) => {
            switch(e.key) {
                case 'ArrowUp':
                case 'w':
                    movePlayer(0, -1);
                    e.preventDefault();
                    break;
                case 'ArrowDown':
                case 's':
                    movePlayer(0, 1);
                    e.preventDefault();
                    break;
                case 'ArrowLeft':
                case 'a':
                    movePlayer(-1, 0);
                    e.preventDefault();
                    break;
                case 'ArrowRight':
                case 'd':
                    movePlayer(1, 0);
                    e.preventDefault();
                    break;
                case ' ':
                    interact();
                    e.preventDefault();
                    break;
                case 'Escape':
                    if (game.dialogueOpen) {
                        dialogue.classList.remove('show');
                        game.dialogueOpen = false;
                    }
                    break;
            }
        });

        // Start game
        gameLoop();
    </script>
</body>
</html>